<!DOCTYPE html>
<html lang="ar" dir="rtl" id="mainHtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>أعضاء نصيب | استكشف شريك حياتك في بيئة آمنة</title>
    <meta name="description" content="تصفح قائمة الأعضاء الموثقين في منصة نصيب العالمي. ابحث عن نصيبك حسب المدينة، الحالة الاجتماعية، أو المهنة بكل خصوصية.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    
    <style>
        :root { --primary-green: #15803d; --accent-gold: #fbbf24; }
        body { font-family: 'Cairo', sans-serif; background: #f8fafc; overflow-x: hidden; user-select: none; }
        .bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); z-index: -2; }
        
        .member-card { border-radius: 2rem; background: white; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; border: 1px solid #f1f5f9; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .member-card:hover { transform: translateY(-10px); box-shadow: 0 25px 50px -12px rgba(21, 128, 61, 0.15); }
        .img-box { width: 100%; padding-top: 120%; position: relative; overflow: hidden; background: #e2e8f0; }
        .img-box img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; transition: 0.8s; }
        .blur-effect { filter: blur(25px); transform: scale(1.1); }
        
        .premium-badge { position: absolute; top: 12px; right: 12px; background: linear-gradient(45deg, #fbbf24, #f59e0b); color: white; padding: 4px 12px; border-radius: 50px; font-size: 10px; font-weight: 900; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .online-dot { position: absolute; bottom: 12px; left: 12px; width: 12px; height: 12px; background: #22c55e; border-radius: 50%; border: 2px solid white; z-index: 10; }
        
        .filter-chip { @apply px-5 py-2 rounded-full border border-slate-200 text-sm font-bold text-slate-500 transition-all cursor-pointer whitespace-nowrap bg-white; }
        .filter-chip.active { @apply bg-green-700 border-green-700 text-white shadow-lg shadow-green-200; }
        .action-btn { @apply flex-1 py-2 rounded-xl text-[11px] font-black transition-all active:scale-95 flex items-center justify-center gap-1 shadow-sm; }
        
        .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="pb-24">

    <div id="loadingScreen" class="fixed inset-0 bg-white z-[5000] flex flex-col items-center justify-center">
        <div class="relative">
            <div class="w-20 h-20 border-4 border-green-100 rounded-full"></div>
            <div class="w-20 h-20 border-4 border-green-700 border-t-transparent rounded-full animate-spin absolute top-0"></div>
            <div class="absolute inset-0 flex items-center justify-center text-green-700 font-black">ن</div>
        </div>
        <p id="loadingText" class="mt-6 font-bold text-green-800 animate-pulse text-lg">نتحقق من هويتك...</p>
    </div>

    <div class="bg-canvas"></div>

    <nav class="bg-white/80 backdrop-blur-xl shadow-sm p-4 sticky top-0 z-50 border-b border-slate-100">
        <div class="container mx-auto flex justify-between items-center px-2">
            <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='index.html'">
                <div class="w-10 h-10 bg-green-700 rounded-2xl flex items-center justify-center text-white shadow-lg rotate-3"><i class="fas fa-ring text-lg"></i></div>
                <div>
                    <span class="font-black text-green-800 text-xl block leading-none">نصيب</span>
                    <span class="text-[8px] font-bold text-slate-400">منصة الستر السودانية</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="welcomeUser" class="text-sm font-bold text-slate-600 hidden md:block"></span>
                <div class="h-8 w-[1px] bg-slate-200 hidden md:block"></div>
                <button onclick="logout()" class="w-10 h-10 bg-red-50 text-red-500 rounded-xl flex items-center justify-center hover:bg-red-500 hover:text-white transition-all" title="تسجيل الخروج"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto p-5">
        <div class="mb-8">
            <div class="bg-white rounded-[2rem] p-3 shadow-md flex items-center gap-3 border border-slate-100 mb-5 focus-within:ring-2 focus-within:ring-green-500 transition-all">
                <i class="fas fa-search text-slate-300 mr-2"></i>
                <input type="text" id="searchInput" onkeyup="filterMembers()" placeholder="ابحث بالاسم، المدينة، أو المهنة..." class="w-full bg-transparent outline-none font-black text-slate-700 text-sm">
            </div>
        </div>

        <div class="flex items-center justify-between mb-6 px-2">
            <h3 class="font-black text-slate-800 text-lg">اكتشف شريك حياتك</h3>
            <span class="text-[10px] font-black text-green-700 px-3 py-1 bg-green-50 rounded-full border border-green-100" id="totalCountDisplay">...</span>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="membersGrid">
            <!-- Skeletons for loading state -->
            <div class="member-card skeleton min-h-[250px]"></div>
            <div class="member-card skeleton min-h-[250px]"></div>
            <div class="member-card skeleton min-h-[250px]"></div>
            <div class="member-card skeleton min-h-[250px]"></div>
            <div class="member-card skeleton min-h-[250px] hidden md:flex"></div>
            <div class="member-card skeleton min-h-[250px] hidden lg:flex"></div>
        </div>
    </main>

    <div id="appToast" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 z-[6000] bg-slate-900/95 backdrop-blur shadow-2xl text-white px-8 py-4 rounded-[2rem] text-xs font-black border border-white/10"></div>

    <script>
        const SERVER_URL = "https://sudanese-love--musabalajb.replit.app"; // Your backend URL
        let allMembers = [];

        // 1. Authentication Check on Page Load
        window.onload = function() {
            const token = localStorage.getItem('naseeb_token');
            const userName = localStorage.getItem('naseeb_user_name');

            if (!token) {
                // If no token, redirect to login page immediately
                window.location.href = 'login.html';
                return;
            }

            if (userName) {
                document.getElementById('welcomeUser').innerText = `مرحباً، ${userName}`;
            }

            // If token exists, proceed to fetch members
            fetchMembers(token);
        };

        // 2. Fetch Members from the REAL Backend
        async function fetchMembers(token) {
            const loadingText = document.getElementById('loadingText');
            loadingText.innerText = 'نبحث لك عن نصيبك...';

            try {
                const response = await fetch(`${SERVER_URL}/api/v1/members`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    // Unauthorized, token is invalid or expired
                    logout(); // Clear storage and redirect
                    return;
                }

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                allMembers = data.members;
                renderMembers(allMembers);

            } catch (error) {
                console.error('Failed to fetch members:', error);
                loadingText.innerText = 'حدث خطأ في الاتصال بالخادم.';
                showToast('❌ خطأ في جلب البيانات.', true);
            }
        }

        // 3. Render Members on the Page
        function renderMembers(members) {
            const grid = document.getElementById('membersGrid');
            grid.innerHTML = ""; // Clear skeletons

            if (members.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-center text-slate-500 font-bold">لا يوجد أعضاء لعرضهم حالياً.</p>`;
            } else {
                members.forEach((member, index) => {
                    grid.innerHTML += createCard(member, index);
                });
            }

            document.getElementById('totalCountDisplay').innerText = `${members.length} عضو متاح`;
            document.getElementById('loadingScreen').style.display = 'none';
        }

        // 4. Create Member Card HTML
        function createCard(m, i) {
            const isGold = m.plan && /gold|diamond/i.test(m.plan);
            const badge = isGold ? '<div class="premium-badge"><i class="fas fa-star mr-1"></i>مميز</div>' : '';
            
            // The onclick now stores the full member object in sessionStorage
            return `
                <div class="member-card member-item" data-tags="${m.name} ${m.city} ${m.job}" style="animation-delay: ${i * 0.05}s" onclick='viewProfile(${JSON.stringify(m)})'>
                    <div class="img-box">
                        ${badge}
                        <div class="online-dot"></div>
                        <img src="${m.profileImageUrl || `https://ui-avatars.com/api/?name=${m.name}&background=random`}" loading="lazy">
                    </div>
                    <div class="p-4 flex-1 flex flex-col">
                        <h4 class="font-black text-[13px] text-slate-800 truncate flex items-center gap-1">
                            ${m.name} 
                            ${m.isVerified ? '<i class="fas fa-check-circle text-blue-500 text-[10px]" title="عضو موثق"></i>' : ''}
                        </h4>
                        <p class="text-[10px] text-slate-500 font-bold mb-4"><i class="fas fa-map-marker-alt text-red-400 ml-1"></i>${m.city || 'غير محدد'}</p>
                        <div class="mt-auto flex gap-2">
                            <button class="action-btn bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white"><i class="fas fa-heart"></i></button>
                            <button class="action-btn bg-green-50 text-green-700 hover:bg-green-700 hover:text-white"><i class="fas fa-comment"></i></button>
                        </div>
                    </div>
                </div>`;
        }

        // 5. View Profile Function
        function viewProfile(memberData) {
            // Store the clicked member's data in sessionStorage to pass it to the profile page
            sessionStorage.setItem('currentProfile', JSON.stringify(memberData));
            window.location.href = 'profile.html';
        }

        // 6. Filter and Logout Functions (remain mostly the same)
        function filterMembers() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('.member-item').forEach(el => {
                const tags = el.getAttribute('data-tags').toLowerCase();
                el.style.display = tags.includes(query) ? 'flex' : 'none';
            });
        }

        function logout() {
            localStorage.removeItem('naseeb_token');
            localStorage.removeItem('naseeb_user_name');
            localStorage.removeItem('naseeb_user_id');
            window.location.href = 'login.html';
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('appToast');
            t.innerText = msg;
            t.style.backgroundColor = isError ? '#ef4444' : '#1e293b';
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3500);
        }
    </script>
</body>
</html>
