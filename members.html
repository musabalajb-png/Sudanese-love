<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†ØµÙŠØ¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ | Ù…Ù†ØµØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¢Ù…Ù†Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f0f4f8; overflow-x: hidden; margin: 0; }
        
        .bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(45deg, #fff5f5, #f0fdf4, #f5f3ff, #fff9db);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            z-index: -2;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .heart-bg { position: fixed; color: rgba(255, 182, 193, 0.4); font-size: 20px; pointer-events: none; z-index: -1; animation: fall linear infinite; }
        @keyframes fall { from { transform: translateY(-10vh) rotate(0deg); opacity: 1; } to { transform: translateY(110vh) rotate(360deg); opacity: 0; } }

        .member-card { border-radius: 2.5rem; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); transition: 0.4s; position: relative; border: 1.5px solid rgba(255, 255, 255, 0.5); overflow: hidden; display: flex; flex-direction: column; cursor: pointer; }
        .member-card:hover { transform: scale(1.05) translateY(-10px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .gold-member { border: 2.3px solid #fbbf24 !important; box-shadow: 0 10px 25px rgba(251, 191, 36, 0.2); }
        .img-box { width: 100%; padding-top: 110%; position: relative; overflow: hidden; background: #f8fafc; }
        .img-box img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; transition: 0.6s ease; }
        .blur-effect { filter: blur(30px); transform: scale(1.1); }
        
        .gift-anim { position: absolute; font-size: 2.5rem; animation: floatUp 1.5s ease-out forwards; z-index: 50; pointer-events: none; }
        @keyframes floatUp { 0% { bottom: 20%; opacity: 1; } 100% { bottom: 85%; opacity: 0; transform: scale(2.5) rotate(15deg); } }
        
        .music-btn {
            position: fixed; bottom: 25px; left: 25px; width: 50px; height: 50px;
            background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); z-index: 1000; cursor: pointer; color: #16a34a;
        }
        .music-playing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }

        .vip-tag { position: absolute; top: 12px; right: 12px; background: linear-gradient(135deg, #fbbf24, #d97706); color: white; padding: 3px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; z-index: 10; }
        
        #loadingMembers { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #notificationPanel { position: fixed; bottom: 80px; left: 20px; right: 20px; max-width: 400px; max-height: 300px; background: white; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); z-index: 99; overflow-y: auto; display: none; }
    </style>
</head>
<body class="pb-10">

    <div id="loadingMembers">
        <div class="w-16 h-16 border-4 border-green-700 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-bold text-green-800">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¬ØªÙ…Ø¹ Ù†ØµÙŠØ¨...</p>
    </div>

    <div class="bg-canvas"></div>
    <div id="heartsContainer"></div>

    <div class="music-btn" id="musicToggle" onclick="toggleMusic()">
        <i class="fas fa-music"></i>
        <audio id="bgAudio" loop>
            <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
        </audio>
    </div>

    <button onclick="toggleNotifications()" class="fixed bottom-[85px] right-[25px] w-[50px] h-[50px] bg-red-500 text-white rounded-full shadow-lg z-[1000] flex items-center justify-center">
        <i class="fas fa-bell"></i>
        <span id="notifBadge" class="absolute -top-1 -right-1 bg-white text-red-500 text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold hidden">0</span>
    </button>

    <div id="notificationPanel" class="p-4 border-t-4 border-red-500">
        <h4 class="font-bold text-slate-800 border-b pb-2 mb-2 flex justify-between">
            <span>Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙŠ</span>
            <button onclick="clearNotifications()" class="text-[10px] text-red-400">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
        </h4>
        <div id="notifList" class="space-y-2">
            <p class="text-[11px] text-slate-400 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
        </div>
    </div>

    <div id="giftBanner" class="bg-gradient-to-r from-slate-900 to-slate-800 text-white p-2 text-[10px] text-center font-bold">
        âœ¨ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¢Ù† Ù…Ø¨Ø§Ø´Ø± ÙˆØ­ØµØ±ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†ØµØ©.. Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„ØªØ§Ù…Ø©!
    </div>

    <nav class="bg-white/70 backdrop-blur-md shadow-sm p-4 sticky top-0 z-50 border-b border-white/20">
        <div class="container mx-auto flex justify-between items-center px-4">
            <span onclick="window.location.href='index.html'" class="cursor-pointer font-bold text-green-700 text-xl flex items-center gap-2">ğŸ’ Ù†ØµÙŠØ¨</span>
            <div class="flex items-center gap-3">
                <div class="bg-red-50 text-red-600 px-4 py-1.5 rounded-full text-[11px] font-bold border border-red-100 flex items-center gap-1">
                    <span>ğŸŒ¹</span> <span id="roseCount">0</span>
                </div>
                <div class="bg-blue-50 text-blue-600 px-4 py-1.5 rounded-full text-[11px] font-bold border border-blue-100 flex items-center gap-1">
                    <span>ğŸ’Œ</span> <span id="msgCount">0</span>
                </div>
                <button onclick="logout()" class="text-slate-400 hover:text-red-600 transition ml-2"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 mt-2">
        <div class="bg-white/50 backdrop-blur-xl rounded-[1.5rem] p-3 shadow-sm border border-white/50 flex items-center gap-3 mb-6">
            <i class="fas fa-search text-slate-400 ml-2"></i>
            <input type="text" id="searchInput" onkeyup="filterMembers()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©..." class="w-full outline-none text-sm text-slate-700 bg-transparent font-bold">
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mt-4" id="membersGrid"></div>
    </div>

    <div id="chatBox" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl relative border-t-8 border-green-600">
            <div id="chatAvatar" class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-green-50 overflow-hidden shadow-lg"></div>
            <h3 id="targetName" class="font-bold text-center text-xl mb-4 text-slate-800"></h3>
            <textarea id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¹Ø¬Ø§Ø¨Ùƒ Ù‡Ù†Ø§..." class="w-full h-28 p-5 bg-slate-50 rounded-2xl border-none outline-none text-sm"></textarea>
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button id="sendMsgBtn" class="bg-green-600 text-white py-3 rounded-2xl font-bold hover:bg-green-700 transition">Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
                <button onclick="closeChat()" class="bg-slate-100 text-slate-500 py-3 rounded-2xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø¬Ù„Ø³Ø§Øª ---
        const checkAuth = () => {
            if (localStorage.getItem('naseeb_logged') !== 'true') window.location.href = 'index.html';
        };
        checkAuth();

        const logout = () => { localStorage.clear(); window.location.href = 'index.html'; };

        const CONFIG = {
            sheetURL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHsoqVm7cDIUgGw6u5n0yO8U19lyqKLrrskUn6Q7At1Q04hrXdC7HxojsDnxj7Frld2__eJOBBMEX6/pub?output=csv"
        };

        // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©) ---
        function sendInternalNotification(toUser, fromUser, msg) {
            // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±ØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØŒ Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ Database Ù„ØªØ¸Ù‡Ø± Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
            console.log(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ù† ${fromUser} Ø¥Ù„Ù‰ ${toUser}: ${msg}`);
            
            // Ù„Ø­ÙØ¸ "Ø¥Ø¹Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ù…Ø±Ø³Ù„Ø©" Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„Ù„Ø°ÙƒØ±Ù‰
            let mySent = JSON.parse(localStorage.getItem('mySentLikes') || '[]');
            mySent.push({ to: toUser, text: msg, date: new Date().toLocaleString() });
            localStorage.setItem('mySentLikes', JSON.stringify(mySent));
        }

        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            renderNotifications();
        }

        function renderNotifications() {
            const list = document.getElementById('notifList');
            // Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ Ø³ØªØ¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø´ÙŠØª Ø£Ùˆ DB)
            const notifs = JSON.parse(localStorage.getItem('myNotifs') || '[]');
            if(notifs.length === 0) {
                list.innerHTML = `<p class="text-[11px] text-slate-400 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>`;
                return;
            }
            list.innerHTML = notifs.map(n => `
                <div class="bg-slate-50 p-2 rounded-xl border-r-4 border-red-400 animate-pulse">
                    <p class="text-[10px] font-bold text-slate-700">Ù„Ù‚Ø¯ Ø£Ø¹Ø¬Ø¨ Ø¨Ùƒ: ${n.from}</p>
                    <p class="text-[9px] text-slate-500">${n.msg}</p>
                </div>
            `).join('');
        }

        // --- 3. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
        let allMembers = [];
        async function load() {
            const today = new Date().toDateString();
            if (localStorage.getItem('lastVisitDate') !== today) {
                localStorage.setItem('roses', '10'); 
                localStorage.setItem('msgs', '5');
                localStorage.setItem('lastVisitDate', today);
            }

            try {
                const res = await fetch(`${CONFIG.sheetURL}?t=${Date.now()}`);
                const data = await res.text();
                const rows = data.split('\n').map(r => r.trim()).filter(r => r !== "").slice(1);
                const grid = document.getElementById('membersGrid');
                grid.innerHTML = ""; 

                const currentUserName = localStorage.getItem('userName');
                let userPlan = 'Ø¹Ø§Ø¯ÙŠØ©';

                rows.forEach((row, index) => {
                    const cols = row.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                    if(cols[0] === currentUserName) userPlan = cols[2] || 'Ø¹Ø§Ø¯ÙŠØ©';

                    const member = {
                        name: cols[0], plan: cols[2] || 'Ø¹Ø§Ø¯ÙŠØ©', city: cols[3] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                        img: cols[6] || `https://ui-avatars.com/api/?name=${cols[0]}&background=random`,
                        age: cols[1]
                    };
                    allMembers.push(member);

                    const isPaid = /Ø§Ù„Ø³ØªØ±|Ø°Ù‡Ø¨ÙŠØ©|Ù…Ø§Ø³ÙŠØ©/i.test(userPlan);
                    const isGold = member.plan.includes('Ø°Ù‡Ø¨ÙŠØ©');
                    const dataStr = encodeURIComponent(JSON.stringify(member));

                    grid.innerHTML += `
                        <div class="member-card ${isGold ? 'gold-member' : ''}" id="card-${index}">
                            ${isGold ? '<span class="vip-tag"><i class="fas fa-crown"></i> VIP</span>' : ''}
                            <div class="img-box" onclick="viewProfile('${dataStr}')">
                                <img src="${member.img}" class="${isPaid ? '' : 'blur-effect'}">
                            </div>
                            <div class="p-4 text-center">
                                <h4 class="font-bold text-[11px]">${member.name}</h4>
                                <p class="text-[9px] text-slate-400 mb-3">${member.city}</p>
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); dropGift('card-${index}', 'ğŸŒ¹')" class="bg-red-50 text-red-600 p-2 rounded-2xl">ğŸŒ¹</button>
                                    <button onclick="event.stopPropagation(); openChat(${index})" class="bg-green-600 text-white px-3 py-2 rounded-2xl text-[10px] font-bold flex-1">Ø¥Ø¹Ø¬Ø§Ø¨</button>
                                </div>
                            </div>
                        </div>`;
                });
                document.getElementById('loadingMembers').style.display = 'none';
                updateCounters();
            } catch (e) { console.log(e); }
        }

        function openChat(index) {
            const member = allMembers[index];
            document.getElementById('targetName').innerText = member.name;
            document.getElementById('chatAvatar').innerHTML = `<img src="${member.img}" class="w-full h-full object-cover">`;
            document.getElementById('chatBox').classList.remove('hidden');
            document.getElementById('sendMsgBtn').onclick = () => sendLikeInside(member.name);
        }

        function sendLikeInside(targetName) {
            let m = parseInt(localStorage.getItem('msgs'));
            const text = document.getElementById('msgInput').value;
            if(!text.trim()) return;
            if(m <= 0) return alert("Ø§Ù†ØªÙ‡Ù‰ Ø±ØµÙŠØ¯ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ");

            localStorage.setItem('msgs', m - 1);
            updateCounters();

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹
            sendInternalNotification(targetName, localStorage.getItem('userName'), text);

            alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ø¬Ø§Ø¨Ùƒ Ù„Ù€ ${targetName} Ø¨Ù†Ø¬Ø§Ø­ âœ…`);
            closeChat();
            document.getElementById('msgInput').value = "";
        }

        // --- Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ---
        function updateCounters() {
            document.getElementById('roseCount').innerText = localStorage.getItem('roses') || 0;
            document.getElementById('msgCount').innerText = localStorage.getItem('msgs') || 0;
        }

        function dropGift(cardId, emoji) {
            let r = parseInt(localStorage.getItem('roses'));
            if(r <= 0) return;
            localStorage.setItem('roses', r - 1);
            updateCounters();
            const gift = document.createElement('div');
            gift.className = 'gift-anim'; gift.innerHTML = emoji; gift.style.left = "45%";
            document.getElementById(cardId).appendChild(gift);
            setTimeout(() => gift.remove(), 1500);
        }

        function closeChat() { document.getElementById('chatBox').classList.add('hidden'); }
        function viewProfile(d) { sessionStorage.setItem('currentProfile', decodeURIComponent(d)); window.location.href = 'profile.html'; }
        
        function toggleMusic() {
            const a = document.getElementById('bgAudio');
            const b = document.getElementById('musicToggle');
            if(a.paused) { a.play(); b.classList.add('music-playing'); }
            else { a.pause(); b.classList.remove('music-playing'); }
        }

        // Ù‚Ù„ÙˆØ¨ Ø®Ù„ÙÙŠØ©
        setInterval(() => {
            const h = document.createElement('div');
            h.className = 'heart-bg'; h.innerHTML = 'â¤ï¸';
            h.style.left = Math.random() * 100 + 'vw';
            h.style.animationDuration = (Math.random() * 3 + 2) + 's';
            document.getElementById('heartsContainer').appendChild(h);
            setTimeout(() => h.remove(), 5000);
        }, 2000);

        window.onload = load;
    </script>
</body>
</html>
