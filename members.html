<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†ØµÙŠØ¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ | Ù…Ù†ØµØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¢Ù…Ù†Ø©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary-green: #16a34a; --heart-pink: rgba(255, 182, 193, 0.4); }
        body { font-family: 'Cairo', sans-serif; background: #f0f4f8; overflow-x: hidden; margin: 0; user-select: none; }
        
        /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© */
        .bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, #fff5f5, #f0fdf4, #f5f3ff, #fff9db); background-size: 400% 400%; animation: gradientBG 15s ease infinite; z-index: -2; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Ø§Ù„Ù‚Ù„ÙˆØ¨ Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        .heart-bg { position: fixed; color: var(--heart-pink); font-size: 20px; pointer-events: none; z-index: -1; animation: fall linear infinite; }
        @keyframes fall { from { transform: translateY(-10vh) rotate(0deg); opacity: 1; } to { transform: translateY(110vh) rotate(360deg); opacity: 0; } }

        /* ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† */
        .member-card { border-radius: 2.5rem; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(10px); transition: 0.4s; position: relative; border: 1.5px solid rgba(255, 255, 255, 0.5); overflow: hidden; display: flex; flex-direction: column; }
        .member-card:hover { transform: scale(1.03) translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .img-box { width: 100%; padding-top: 115%; position: relative; overflow: hidden; background: #f1f5f9; }
        .img-box img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; transition: 0.5s; }
        .blur-effect { filter: blur(25px); transform: scale(1.1); }
        
        /* Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† */
        .gift-anim { position: absolute; font-size: 2.5rem; animation: floatUp 1.5s ease-out forwards; z-index: 50; pointer-events: none; }
        @keyframes floatUp { 0% { bottom: 20%; opacity: 1; } 100% { bottom: 85%; opacity: 0; transform: scale(2.5); } }
        
        #notificationPanel { position: fixed; bottom: 90px; left: 20px; right: 20px; max-width: 350px; max-height: 450px; background: white; border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); z-index: 2000; overflow-y: auto; display: none; border: 3px solid #ef4444; }
        
        /* Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ */
        .music-btn { position: fixed; bottom: 25px; left: 25px; width: 55px; height: 55px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 1000; cursor: pointer; color: var(--primary-green); transition: 0.3s; }
        .music-btn:active { transform: scale(0.9); }
        .music-playing { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
    </style>
</head>
<body class="pb-24">

    <div id="loadingMembers" class="fixed inset-0 bg-white z-[5000] flex flex-col items-center justify-center">
        <div class="w-20 h-20 border-8 border-green-100 border-t-green-600 rounded-full animate-spin"></div>
        <p class="mt-6 font-bold text-green-800 animate-pulse text-lg">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ù†ØµÙŠØ¨Ùƒ...</p>
    </div>

    <div class="bg-canvas"></div>
    <div id="heartsContainer"></div>

    <div class="music-btn" id="musicToggle" onclick="toggleMusic()">
        <i class="fas fa-music text-xl"></i>
        <audio id="bgAudio" loop preload="auto">
            <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
        </audio>
    </div>

    <button onclick="toggleNotifications()" class="fixed bottom-6 right-6 w-16 h-16 bg-red-500 text-white rounded-full shadow-2xl z-[2100] flex items-center justify-center transition-all active:scale-90">
        <i class="fas fa-bell text-2xl"></i>
        <span id="notifBadge" class="absolute -top-1 -left-1 bg-yellow-400 text-red-700 text-[12px] w-7 h-7 rounded-full flex items-center justify-center font-black border-2 border-white hidden">0</span>
    </button>

    <div id="notificationPanel" class="p-5 animate-bounce-in">
        <div class="flex justify-between items-center mb-4 border-b pb-3">
            <h4 class="font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-envelope-open-heart text-red-500"></i> Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª ÙˆØµÙ„ØªÙ†ÙŠ
            </h4>
            <button onclick="toggleNotifications()" class="w-8 h-8 bg-slate-100 rounded-full text-slate-400"><i class="fas fa-times"></i></button>
        </div>
        <div id="notifList" class="space-y-4">
            <p class="text-center text-slate-400 py-10 text-sm">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p>
        </div>
    </div>

    <nav class="bg-white/80 backdrop-blur-lg shadow-sm p-4 sticky top-0 z-50 border-b border-white/30">
        <div class="container mx-auto flex justify-between items-center px-2">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-green-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-green-200">
                    <i class="fas fa-ring"></i>
                </div>
                <span class="font-black text-green-700 text-2xl tracking-tighter">Ù†ØµÙŠØ¨</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="bg-red-50 text-red-600 px-3 py-2 rounded-2xl text-[12px] font-bold border border-red-100 flex items-center gap-1">
                    <span>ğŸŒ¹</span> <span id="roseCount">0</span>
                </div>
                <div class="bg-blue-50 text-blue-600 px-3 py-2 rounded-2xl text-[12px] font-bold border border-blue-100 flex items-center gap-1">
                    <span>ğŸ’Œ</span> <span id="msgCount">0</span>
                </div>
                <button onclick="logout()" class="w-10 h-10 bg-slate-50 text-slate-400 rounded-2xl flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition-all"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-5">
        <div class="bg-white/60 backdrop-blur-2xl rounded-[2rem] p-4 shadow-xl shadow-slate-200/50 flex items-center gap-3 mb-8 border border-white">
            <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-slate-400 shadow-sm">
                <i class="fas fa-search"></i>
            </div>
            <input type="text" id="searchInput" onkeyup="filterMembers()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù…Ø± (Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)..." class="w-full bg-transparent outline-none text-md font-bold text-slate-700 placeholder:text-slate-300">
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6" id="membersGrid"></div>
    </div>

    <div id="chatBox" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-xl z-[3000] flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[3.5rem] p-8 shadow-2xl relative border-t-[12px] border-green-600 text-center animate-scale-up">
            <div id="chatAvatar" class="w-24 h-24 rounded-full mx-auto mb-5 border-4 border-green-50 overflow-hidden shadow-2xl ring-8 ring-green-500/10"></div>
            <h3 id="targetName" class="font-black text-2xl mb-2 text-slate-800"></h3>
            <p class="text-xs text-slate-400 mb-6 font-bold uppercase tracking-widest">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ø¬Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±</p>
            <textarea id="msgInput" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ø·ÙŠØ¨Ø© ØªÙØªØ­ Ø§Ù„Ù‚Ù„ÙˆØ¨..." class="w-full h-32 p-5 bg-slate-50 rounded-[2rem] outline-none text-sm border-2 border-transparent focus:border-green-200 transition-all shadow-inner"></textarea>
            <div class="grid grid-cols-2 gap-4 mt-8">
                <button id="sendMsgBtn" class="bg-green-600 text-white py-4 rounded-[1.5rem] font-black shadow-xl shadow-green-200 active:scale-95 transition-all">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù† ğŸš€</button>
                <button onclick="closeChat()" class="bg-slate-100 text-slate-500 py-4 rounded-[1.5rem] font-bold active:scale-95">ØªØ±Ø§Ø¬Ø¹</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ù…Ø§Ù† ---
        const CONFIG = {
            sheetURL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRHsoqVm7cDIUgGw6u5n0yO8U19lyqKLrrskUn6Q7At1Q04hrXdC7HxojsDnxj7Frld2__eJOBBMEX6/pub?output=csv",
            scriptURL: "https://script.google.com/macros/s/AKfycbzOqsZZEKV2FyCQxMRxo2aB8Ld4txzXFdYEKGwXCb48ymeM6nOufWVZmv65jVErV3sL_Q/exec"
        };

        const checkAuth = () => {
            if (localStorage.getItem('naseeb_logged') !== 'true') window.location.href = 'index.html';
        };
        checkAuth();

        const logout = () => { 
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
                localStorage.clear(); 
                window.location.href = 'index.html';
            }
        };

        let allMembers = [];
        let isPlaying = false;

        // --- 2. Ù…Ø­Ø±Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        async function load() {
            try {
                const res = await fetch(`${CONFIG.sheetURL}?cb=${Date.now()}`);
                const data = await res.text();
                const rows = data.split('\n').slice(1);
                const grid = document.getElementById('membersGrid');
                grid.innerHTML = "";
                
                const myPlan = localStorage.getItem('userPlan') || 'Ø¹Ø§Ø¯ÙŠØ©';
                const isPaid = /Ø§Ù„Ø³ØªØ±|Ø°Ù‡Ø¨ÙŠØ©|Ù…Ø§Ø³ÙŠØ©/i.test(myPlan);

                rows.forEach((row, index) => {
                    const cols = row.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                    if(!cols[0] || cols[0].length < 2) return;
                    
                    const member = { 
                        name: cols[0], 
                        city: cols[3] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯', 
                        img: cols[6] || `https://ui-avatars.com/api/?name=${encodeURIComponent(cols[0])}&background=random&size=256`,
                        plan: cols[2] || 'Ø¹Ø§Ø¯ÙŠØ©'
                    };
                    allMembers.push(member);

                    const isGolden = member.plan.includes('Ø°Ù‡Ø¨ÙŠØ©') || member.plan.includes('Ù…Ø§Ø³ÙŠØ©');

                    grid.innerHTML += `
                        <div class="member-card ${isGolden ? 'ring-2 ring-yellow-400' : ''}" id="card-${index}" onclick="viewProfile('${encodeURIComponent(JSON.stringify(member))}')">
                            <div class="img-box">
                                <img src="${member.img}" class="${isPaid ? '' : 'blur-effect'}" loading="lazy" onerror="this.src='https://ui-avatars.com/api/?name=User'">
                                ${isGolden ? '<div class="absolute top-3 right-3 bg-yellow-400 text-white p-1 px-2 rounded-lg text-[8px] font-black shadow-lg">Ø¹Ø¶Ùˆ Ù…Ù…ÙŠØ²</div>' : ''}
                            </div>
                            <div class="p-4 text-center">
                                <h4 class="font-black text-sm truncate text-slate-700 mb-1">${member.name}</h4>
                                <p class="text-[10px] text-slate-400 mb-4 flex items-center justify-center gap-1">
                                    <i class="fas fa-location-dot text-red-300"></i> ${member.city}
                                </p>
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); dropRose('card-${index}')" class="bg-red-50 text-red-600 w-10 h-10 flex items-center justify-center rounded-2xl text-lg hover:bg-red-100 transition-all">ğŸŒ¹</button>
                                    <button onclick="event.stopPropagation(); openChat(${index})" class="bg-green-600 text-white px-2 py-2 rounded-2xl text-[11px] font-black flex-1 shadow-lg shadow-green-100 active:scale-95 transition-all">Ø¥Ø¹Ø¬Ø§Ø¨ ğŸ’Œ</button>
                                </div>
                            </div>
                        </div>`;
                });
                document.getElementById('loadingMembers').style.display = 'none';
                updateCounters();
                checkMyNotifications(); 
                startHeartEffect();
            } catch (e) { 
                console.error("Critical Load Error");
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹");
            }
        }

        // --- 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ---
        async function sendLikeInside(targetName) {
            let m = parseInt(localStorage.getItem('msgs') || 5);
            const text = document.getElementById('msgInput').value.trim();
            
            if(!text) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨");
            if(m <= 0) return alert("Ø±ØµÙŠØ¯Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø§Ù†ØªÙ‡Ù‰ (5/5)");

            const btn = document.getElementById('sendMsgBtn');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..."; btn.disabled = true;

            try {
                await fetch(CONFIG.scriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        sender: localStorage.getItem('userName'),
                        receiver: targetName,
                        message: text
                    })
                });
                localStorage.setItem('msgs', m - 1);
                updateCounters();
                alert(`Ø±Ø³Ø§Ù„ØªÙƒ Ø·Ø§Ø±Øª Ù„Ù€ ${targetName}! âœ…`);
                closeChat();
            } catch (e) { alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªØ¹Ø°Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹"); }
            btn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù† ğŸš€"; btn.disabled = false;
        }

        async function checkMyNotifications() {
            const currentUser = localStorage.getItem('userName');
            try {
                const res = await fetch(CONFIG.scriptURL);
                const likes = await res.json();
                const myLikes = likes.filter(l => l.receiver === currentUser);
                
                const list = document.getElementById('notifList');
                const badge = document.getElementById('notifBadge');
                
                if(myLikes.length > 0) {
                    badge.innerText = myLikes.length;
                    badge.classList.remove('hidden');
                    list.innerHTML = myLikes.reverse().map(l => `
                        <div class="bg-slate-50 p-4 rounded-3xl border-r-8 border-red-400 shadow-sm">
                            <div class="flex justify-between items-start mb-1">
                                <p class="text-[11px] font-black text-slate-800">Ù…Ù†: ${l.sender}</p>
                                <p class="text-[8px] text-slate-300 font-bold">${new Date(l.time).toLocaleDateString('ar-SA')}</p>
                            </div>
                            <p class="text-[12px] text-slate-600 leading-relaxed font-bold">${l.message}</p>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = `<div class="text-center py-10"><i class="fas fa-heart-crack text-slate-200 text-4xl mb-3"></i><p class="text-slate-400 text-sm font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ù„Ø­Ø¸Ø©</p></div>`;
                }
            } catch(e) { console.log("Silent Error: Notif Fetch"); }
        }

        // --- 4. Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª ÙˆØ§Ù„ØªØ­ÙƒÙ… ---
        function toggleMusic() {
            const audio = document.getElementById('bgAudio');
            const btn = document.getElementById('musicToggle');
            if(isPlaying) { audio.pause(); btn.innerHTML = '<i class="fas fa-music"></i>'; }
            else { audio.play(); btn.innerHTML = '<i class="fas fa-pause"></i>'; }
            isPlaying = !isPlaying; btn.classList.toggle('music-playing');
        }

        function startHeartEffect() {
            setInterval(() => {
                if(document.visibilityState !== 'visible') return;
                const h = document.createElement('div');
                h.className = 'heart-bg'; h.innerHTML = ['â¤ï¸','
